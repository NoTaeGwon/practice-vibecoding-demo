---
globs: apps/api/**/*.ts
description: AWS Lambda 백엔드 개발 규칙 (TDD 필수)
---

# 백엔드 Lambda 규칙

## 디렉터리 구조

- `apps/api/src/domain/`: 도메인 엔티티/서비스 (`Todo`, `TodoService`, `TodoRepository` 인터페이스)
- `apps/api/src/infra/`: DynamoDB 구현체, AWS SDK 연동
- `apps/api/src/handlers/`: Lambda 핸들러 (`createTodoHandler`, `listTodosHandler` 등)
- `apps/api/src/types/`: API 타입 정의

## TDD 필수

**모든 백엔드 코드는 반드시 TDD로 구현합니다.**

### 도메인/서비스 (`src/domain/`)
1. 테스트 작성: 비즈니스 규칙(생성 시 기본값, 상태 전이, 유효성 검사)을 테스트로 먼저 정의
2. 최소 구현: 테스트를 통과하는 최소한의 코드 작성
3. 리팩터링: 코드 품질 개선

### Lambda 핸들러 (`src/handlers/`)
1. 테스트 작성: 이벤트/컨텍스트를 mock하여 HTTP 레벨 입출력 검증
2. 도메인 서비스는 mock/fake로 주입하여 HTTP/에러 처리 로직에 집중
3. 구현 및 리팩터링

## 아키텍처 원칙

- **Lambda 핸들러는 얇게**: HTTP 요청/응답 변환, 에러 처리만 담당
- **도메인 서비스는 두껍게**: 비즈니스 로직은 도메인 서비스에 집중
- **Repository 패턴**: DynamoDB 접근은 `TodoRepository` 인터페이스를 통해 추상화

## API 엔드포인트

요구사항 참조: [docs/requirements.md](mdc:docs/requirements.md) 섹션 6.2

- `POST /todos`: TODO 생성
- `GET /todos`: TODO 목록 조회 (쿼리: `q`, `filter`, `priority`)
- `PUT /todos/{todoId}`: TODO 수정
- `DELETE /todos/{todoId}`: TODO 삭제

## 인증 및 권한

- AWS Cognito User Pool Authorizer 사용
- 비로그인 사용자 차단 (401 Unauthorized)
- TODO 데이터는 `userId`로 사용자별 분리

## DynamoDB

- 테이블: `Todos`
- 파티션 키: `userId` (Cognito User ID)
- 정렬 키: `todoId` (UUID)
- 조건부 쓰기로 데이터 무결성 보장

## TypeScript 규칙

- `interface` 우선 사용
- enum 대신 리터럴 유니온 사용
- 공통 도메인 타입은 `packages/shared` 또는 `apps/api/src/domain`에서 재사용
